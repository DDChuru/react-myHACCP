<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Inspection Feature - Visual Flow Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .description {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        .screen-mockup {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
    </style>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2980b9',
                lineColor: '#5a6c7d',
                secondaryColor: '#e74c3c',
                tertiaryColor: '#f39c12',
                background: '#ecf0f1',
                mainBkg: '#3498db',
                secondBkg: '#e74c3c',
                tertiaryBkg: '#f39c12'
            }
        });
    </script>
</head>
<body>
    <h1>üîç Self-Inspection Feature - Complete Visual Flow</h1>
    
    <div class="description">
        <strong>Overview:</strong> The self-inspection feature enables food safety personnel to conduct systematic facility inspections, 
        document findings, capture photographic evidence, and generate compliance reports. This visual guide shows the complete 
        user journey from inspection initiation to completion.
    </div>

    <h2>1. High-Level User Journey</h2>
    <div class="diagram-container">
        <div class="mermaid">
            graph TB
                Start([User Opens App]) --> Auth{Authenticated?}
                Auth -->|No| Login[Login Screen]
                Auth -->|Yes| Dashboard[Main Dashboard]
                Login --> Dashboard
                Dashboard --> SelfInsp[Self-Inspection Module]
                
                SelfInsp --> List[Inspection List View]
                List --> Decision{Action?}
                
                Decision -->|New| Create[Create New Inspection]
                Decision -->|Resume| Conduct[Conduct Inspection]
                Decision -->|View| ViewComplete[View Completed]
                Decision -->|Dashboard| Analytics[Analytics Dashboard]
                
                Create --> SiteSelect[Select Site]
                SiteSelect --> Config[Configure Options]
                Config --> StartInsp[Start Inspection]
                StartInsp --> Conduct
                
                Conduct --> Areas[Inspect Areas]
                Areas --> Issues{Issues Found?}
                Issues -->|Yes| AddIssue[Add Issue + Photos]
                Issues -->|No| NextArea[Next Area]
                AddIssue --> NextArea
                NextArea --> Complete{All Areas Done?}
                Complete -->|No| Areas
                Complete -->|Yes| Sign[Digital Signature]
                Sign --> Save[Save & Complete]
                Save --> Report[Generate Report]
                
                style Start fill:#2ecc71
                style Report fill:#e74c3c
                style AddIssue fill:#f39c12
                style Sign fill:#9b59b6
        </div>
    </div>

    <h2>2. Navigation Flow & Screen Transitions</h2>
    <div class="diagram-container">
        <div class="mermaid">
            stateDiagram-v2
                [*] --> MainDashboard
                MainDashboard --> SelfInspectionList: Navigate to Module
                
                SelfInspectionList --> NewInspection: FAB (+) Button
                SelfInspectionList --> ConductInspection: Tap Inspection Card
                SelfInspectionList --> ViewInspection: Tap Completed
                SelfInspectionList --> AnalyticsDashboard: Dashboard Icon
                
                NewInspection --> SiteSelection: Auto Load
                SiteSelection --> OptionsConfig: Select Site
                OptionsConfig --> ConductInspection: Start Inspection
                
                ConductInspection --> AddIssue: Add Issue Button
                AddIssue --> AreaSelection: Select Area
                AreaSelection --> IssueDetails: Enter Details
                IssueDetails --> PhotoCapture: Add Photos
                PhotoCapture --> ConductInspection: Save Issue
                
                ConductInspection --> SignatureCapture: Complete Button
                SignatureCapture --> CompletionConfirm: Sign & Save
                CompletionConfirm --> SelfInspectionList: Return
                
                note right of PhotoCapture
                    - Before photos
                    - After photos
                    - Annotations
                end note
                
                note left of ConductInspection
                    - Area checklist
                    - Issue tracking
                    - Progress indicator
                end note
        </div>
    </div>

    <h2>3. Data Flow & State Management</h2>
    <div class="diagram-container">
        <div class="mermaid">
            graph LR
                subgraph "Frontend State"
                    LocalState[Local State<br/>useState/useReducer]
                    Context[Auth Context]
                    Params[Route Params]
                end
                
                subgraph "Data Layer"
                    Firebase[(Firebase<br/>Firestore)]
                    Storage[(Firebase<br/>Storage)]
                end
                
                subgraph "Services"
                    InspService[selfInspectionService]
                    SyncService[syncService]
                    AuthService[authService]
                end
                
                LocalState <--> InspService
                Context <--> AuthService
                Params --> LocalState
                
                InspService <--> Firebase
                InspService <--> Storage
                SyncService <--> Firebase
                AuthService <--> Firebase
                
                Firebase --> Offline[Offline Cache]
                Offline --> LocalState
                
                style Firebase fill:#ffa500
                style Storage fill:#4169e1
                style LocalState fill:#32cd32
        </div>
    </div>

    <h2>4. Screen-by-Screen Flow</h2>
    
    <h3>4.1 Self-Inspection List Screen</h3>
    <div class="diagram-container">
        <div class="mermaid">
            graph TD
                subgraph "List Screen Components"
                    Header[Header with Sync Status]
                    Search[Search Bar]
                    Filter[Status Filters]
                    Cards[Inspection Cards]
                    FAB[FAB New Button]
                end
                
                Header --> SyncAction[Pull to Refresh]
                Cards --> CardContent[Show: Name, Site, Status, Progress]
                Cards --> CardActions{User Tap}
                CardActions -->|Pending/Draft| Resume[Resume Inspection]
                CardActions -->|Completed| View[View Details]
                
                FAB --> NewFlow[New Inspection Flow]
                
                style Header fill:#3498db
                style FAB fill:#e74c3c
        </div>
    </div>

    <h3>4.2 New Inspection Flow</h3>
    <div class="diagram-container">
        <div class="mermaid">
            flowchart TD
                subgraph "Step 1: Site Selection"
                    Sites[Load User Sites]
                    Sites --> RoleCheck{Check Role}
                    RoleCheck -->|Admin| AllSites[Show All Sites]
                    RoleCheck -->|User| AllocatedSites[Show Allocated Sites]
                    AllSites --> SiteList[Site List with Search]
                    AllocatedSites --> SiteList
                    SiteList --> SelectSite[User Selects Site]
                end
                
                subgraph "Step 2: Configuration"
                    SelectSite --> LoadAreas[Load Site Areas]
                    LoadAreas --> Options[Configure Options]
                    Options --> NameInput[Inspection Name Input]
                    Options --> NCRToggle[NCR Creation Toggle]
                    Options --> PhotoToggle[Before/After Photos Toggle]
                end
                
                subgraph "Step 3: Initialization"
                    PhotoToggle --> CreateRecord[Create Firestore Record]
                    CreateRecord --> SetStatus[Status: 'pending']
                    SetStatus --> Navigate[Navigate to Conduct Screen]
                end
                
                style Sites fill:#2ecc71
                style CreateRecord fill:#e74c3c
        </div>
    </div>

    <h3>4.3 Conduct Inspection Screen</h3>
    <div class="diagram-container">
        <div class="mermaid">
            flowchart LR
                subgraph "Main View"
                    Progress[Progress Indicator]
                    AreaList[Area List]
                    IssueCount[Issue Counter]
                    Actions[Action Buttons]
                end
                
                subgraph "Area Inspection"
                    AreaList --> AreaCard[Area Card]
                    AreaCard --> Status{Status}
                    Status -->|Not Started| Gray[Gray Indicator]
                    Status -->|In Progress| Yellow[Yellow Indicator]
                    Status -->|Completed| Green[Green Indicator]
                    Status -->|Has Issues| Red[Red Badge]
                end
                
                subgraph "Issue Management"
                    Actions --> AddIssueBtn[Add Issue Button]
                    AddIssueBtn --> IssueFlow[Issue Creation Flow]
                    IssueFlow --> SaveIssue[Save to Inspection]
                    SaveIssue --> UpdateCount[Update Counters]
                end
                
                subgraph "Completion"
                    Actions --> CompleteBtn[Complete Button]
                    CompleteBtn --> Validation{Validate}
                    Validation -->|All Areas Done| SignatureModal[Signature Modal]
                    Validation -->|Incomplete| Warning[Show Warning]
                    SignatureModal --> SaveComplete[Save & Complete]
                end
                
                style Progress fill:#3498db
                style Red fill:#e74c3c
                style Green fill:#2ecc71
                style SignatureModal fill:#9b59b6
        </div>
    </div>

    <h3>4.4 Add Issue Flow</h3>
    <div class="diagram-container">
        <div class="mermaid">
            sequenceDiagram
                participant User
                participant AddIssueScreen
                participant Camera
                participant Firebase
                participant ConductScreen
                
                User->>AddIssueScreen: Tap Add Issue
                AddIssueScreen->>User: Show Area Selection
                User->>AddIssueScreen: Select Area
                AddIssueScreen->>User: Show Issue Form
                
                Note over User, AddIssueScreen: Issue Details Entry
                User->>AddIssueScreen: Enter Description
                User->>AddIssueScreen: Select Category
                User->>AddIssueScreen: Select Severity
                User->>AddIssueScreen: Set Action Date
                User->>AddIssueScreen: Assign Responsible
                
                opt Before/After Photos Enabled
                    User->>Camera: Capture Before Photo
                    Camera->>AddIssueScreen: Return Photo
                    AddIssueScreen->>Firebase: Upload Photo
                    Firebase->>AddIssueScreen: Return URL
                    
                    User->>Camera: Capture After Photo
                    Camera->>AddIssueScreen: Return Photo
                    AddIssueScreen->>Firebase: Upload Photo
                    Firebase->>AddIssueScreen: Return URL
                end
                
                User->>AddIssueScreen: Save Issue
                AddIssueScreen->>Firebase: Update Inspection
                Firebase->>ConductScreen: Return to Conduct
                ConductScreen->>User: Show Updated Issues
        </div>
    </div>

    <h2>5. User Interaction States</h2>
    <div class="diagram-container">
        <div class="mermaid">
            stateDiagram-v2
                [*] --> Idle
                
                Idle --> Loading: Fetch Data
                Loading --> Error: API Error
                Loading --> Loaded: Success
                Error --> Idle: Retry
                
                Loaded --> Viewing: Display Data
                Viewing --> Editing: User Action
                Editing --> Validating: Submit
                Validating --> Saving: Valid Data
                Validating --> Editing: Invalid Data
                Saving --> Syncing: Save to Cloud
                Syncing --> Completed: Success
                Syncing --> OfflineQueue: No Connection
                OfflineQueue --> Syncing: Connection Restored
                Completed --> Idle: Reset
                
                note right of OfflineQueue
                    Data saved locally
                    Auto-sync when online
                end note
                
                note left of Validating
                    - Required fields
                    - Data formats
                    - Business rules
                end note
        </div>
    </div>

    <h2>6. Component Hierarchy</h2>
    <div class="diagram-container">
        <div class="mermaid">
            graph TD
                App[App Root]
                App --> AuthProvider[AuthProvider]
                AuthProvider --> Router[Expo Router]
                
                Router --> DrawerLayout[Drawer Layout]
                DrawerLayout --> SelfInspection[Self-Inspection Screen]
                
                SelfInspection --> Header[Header Component]
                SelfInspection --> InspectionList[Inspection List]
                SelfInspection --> FAB1[FAB Component]
                
                InspectionList --> InspectionCard[Inspection Card]
                InspectionCard --> StatusChip[Status Chip]
                InspectionCard --> ProgressBar[Progress Bar]
                InspectionCard --> IssueIndicator[Issue Indicator]
                
                Router --> NewInspection[New Inspection Screen]
                NewInspection --> SiteSelector[Site Selector]
                NewInspection --> OptionsForm[Options Form]
                
                Router --> ConductScreen[Conduct Screen]
                ConductScreen --> AreaNavigator[Area Navigator]
                ConductScreen --> IssueList[Issue List]
                ConductScreen --> SignatureCapture[Signature Capture]
                
                Router --> AddIssueScreen[Add Issue Screen]
                AddIssueScreen --> IssueForm[Issue Form]
                AddIssueScreen --> ImagePicker[Image Picker]
                AddIssueScreen --> ImageAnnotator[Image Annotator]
                
                style App fill:#2c3e50
                style AuthProvider fill:#3498db
                style SelfInspection fill:#e74c3c
                style ConductScreen fill:#f39c12
        </div>
    </div>

    <h2>7. Data Schema Visualization</h2>
    <div class="diagram-container">
        <div class="mermaid">
            erDiagram
                COMPANY ||--o{ SELF_INSPECTION : has
                COMPANY ||--o{ SITE : contains
                COMPANY ||--o{ USER : employs
                SITE ||--o{ AREA : contains
                USER ||--o{ SELF_INSPECTION : conducts
                SELF_INSPECTION ||--o{ ISSUE : contains
                AREA ||--o{ ISSUE : location
                USER ||--o{ ISSUE : assigned
                
                SELF_INSPECTION {
                    string id PK
                    string name
                    string status
                    string siteId FK
                    string userId FK
                    date scheduledDate
                    date completedAt
                    int totalItems
                    int completedItems
                    string signature
                }
                
                ISSUE {
                    string id PK
                    string inspectionId FK
                    string areaId FK
                    string category
                    string severity
                    string description
                    array images
                    date actionDate
                    string assignedTo FK
                    string status
                }
                
                SITE {
                    string id PK
                    string companyId FK
                    string name
                    string address
                }
                
                AREA {
                    string id PK
                    string siteId FK
                    string name
                    string type
                }
        </div>
    </div>

    <h2>8. Error Handling & Edge Cases</h2>
    <div class="diagram-container">
        <div class="mermaid">
            flowchart TD
                Action[User Action] --> Check{Check Conditions}
                
                Check -->|No Network| OfflineMode[Offline Mode]
                OfflineMode --> LocalSave[Save Locally]
                LocalSave --> QueueSync[Queue for Sync]
                QueueSync --> ShowOffline[Show Offline Indicator]
                
                Check -->|Auth Expired| AuthError[Auth Error]
                AuthError --> RefreshToken[Refresh Token]
                RefreshToken -->|Success| RetryAction[Retry Action]
                RefreshToken -->|Fail| LoginScreen[Redirect to Login]
                
                Check -->|Invalid Data| ValidationError[Validation Error]
                ValidationError --> ShowError[Show Error Message]
                ShowError --> CorrectInput[User Corrects Input]
                
                Check -->|Server Error| ServerError[Server Error]
                ServerError --> RetryLogic{Retry Logic}
                RetryLogic -->|Attempt 1| Delay1[Wait 1s]
                RetryLogic -->|Attempt 2| Delay2[Wait 2s]
                RetryLogic -->|Attempt 3| Delay3[Wait 4s]
                RetryLogic -->|Max Attempts| ShowServerError[Show Error Dialog]
                
                Check -->|Success| ProcessAction[Process Action]
                ProcessAction --> UpdateUI[Update UI]
                UpdateUI --> ShowSuccess[Show Success Feedback]
                
                style OfflineMode fill:#f39c12
                style AuthError fill:#e74c3c
                style ValidationError fill:#e67e22
                style ServerError fill:#c0392b
                style ShowSuccess fill:#2ecc71
        </div>
    </div>

    <h2>9. Performance Optimization Flow</h2>
    <div class="diagram-container">
        <div class="mermaid">
            graph TB
                subgraph "Data Loading Strategy"
                    InitialLoad[Initial Load] --> CheckCache{Cache Available?}
                    CheckCache -->|Yes| LoadCache[Load from Cache]
                    CheckCache -->|No| LoadRemote[Load from Server]
                    LoadCache --> DisplayCache[Display Cached Data]
                    DisplayCache --> BackgroundSync[Background Sync]
                    LoadRemote --> UpdateCache[Update Cache]
                    UpdateCache --> DisplayRemote[Display Fresh Data]
                    BackgroundSync --> UpdateIfNeeded[Update if Changed]
                end
                
                subgraph "Image Handling"
                    CaptureImage[Capture Image] --> Compress[Compress Image]
                    Compress --> Thumbnail[Generate Thumbnail]
                    Thumbnail --> UploadBoth[Upload Both Versions]
                    UploadBoth --> DisplayThumb[Display Thumbnail]
                    DisplayThumb --> LazyLoadFull[Lazy Load Full on Tap]
                end
                
                subgraph "List Optimization"
                    LongList[Long List Data] --> Virtualization[Use FlatList]
                    Virtualization --> RenderWindow[Render Window]
                    RenderWindow --> RecycleViews[Recycle Views]
                    RecycleViews --> OptimizedRender[Optimized Rendering]
                end
                
                style CheckCache fill:#3498db
                style Compress fill:#2ecc71
                style Virtualization fill:#f39c12
        </div>
    </div>

    <h2>10. Complete User Journey Example</h2>
    <div class="diagram-container">
        <div class="mermaid">
            journey
                title Self-Inspection User Journey - Field Inspector Sarah
                
                section Morning Preparation
                  Open App: 5: Sarah
                  Check Notifications: 4: Sarah
                  View Inspection List: 5: Sarah
                  See Pending Inspection: 3: Sarah
                  
                section Start Inspection
                  Tap Inspection Card: 5: Sarah
                  Review Site Details: 4: Sarah
                  Start Inspection: 5: Sarah
                  View Area List: 5: Sarah
                  
                section Conduct Inspection
                  Inspect Kitchen Area: 5: Sarah
                  Find Temperature Issue: 2: Sarah
                  Add Issue with Photo: 4: Sarah
                  Assign to Manager: 4: Sarah
                  Continue to Storage: 5: Sarah
                  All Areas Complete: 5: Sarah
                  
                section Complete & Submit
                  Review Issues Found: 4: Sarah
                  Add Digital Signature: 5: Sarah
                  Submit Inspection: 5: Sarah
                  View Confirmation: 5: Sarah
                  
                section Follow-up
                  Manager Gets Alert: 3: Manager
                  Reviews Issue: 4: Manager
                  Takes Corrective Action: 5: Manager
                  Updates Issue Status: 5: Manager
        </div>
    </div>

    <div class="legend">
        <h3>Legend:</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #2ecc71;"></div>
            <span>Success/Complete</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #3498db;"></div>
            <span>In Progress</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f39c12;"></div>
            <span>Warning/Attention</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span>Error/Issue</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9b59b6;"></div>
            <span>Signature/Auth</span>
        </div>
    </div>

    <div class="description">
        <h3>üì± Implementation Notes:</h3>
        <ul>
            <li><strong>Navigation:</strong> Uses Expo Router with nested navigation (Drawer > Stack)</li>
            <li><strong>State Management:</strong> React Context for auth, local state for forms</li>
            <li><strong>Data Persistence:</strong> Firebase Firestore with offline support</li>
            <li><strong>Image Storage:</strong> Firebase Storage with compression</li>
            <li><strong>Authentication:</strong> Firebase Auth with role-based access</li>
            <li><strong>UI Framework:</strong> React Native Paper (Material Design 3)</li>
            <li><strong>Performance:</strong> FlatList virtualization, image lazy loading, cache-first strategy</li>
            <li><strong>Offline Support:</strong> Local queue with background sync</li>
        </ul>
    </div>
</body>
</html>